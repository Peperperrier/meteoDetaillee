<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Météo 🪂 43</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gradient-to-r from-blue-100 to-blue-300 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">Météo Parapente Haute-Loire</h1>
            <div class="flex mt-4">
                <select id="cityDropdown" 
                    class="flex-grow p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Sélectionnez une ville</option>
                </select>
                <button onclick="fetchWeather()" 
                    class="bg-blue-500 text-white p-2 rounded-r-lg hover:bg-blue-600 transition">
                    Rechercher
                </button>
            </div>
        </div>

        <div id="weatherInfo" class="hidden">
            <div class="text-center">
                <h2 id="cityName" class="text-2xl font-semibold"></h2>
                <div id="additionalInfo" class="text-lg text-gray-700 mt-2"></div> <!-- Conteneur pour les infos supplémentaires -->
                <div id="temperature" class="text-5xl font-bold text-blue-700 my-4"></div>
                
                <div class="grid grid-cols-3 gap-4 mt-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <i class="fas fa-wind text-blue-500 text-2xl mb-2"></i>
                        <div>
                            <strong>Vitesse du Vent</strong>
                            <div id="windSpeed" class="text-xl font-bold"></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <i class="fas fa-compass text-blue-500 text-2xl mb-2"></i>
                        <div>
                            <strong>Direction du Vent</strong>
                            <div id="windDirection" class="text-xl font-bold"></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <i class="fas fa-bolt text-yellow-500 text-2xl mb-2"></i>
                        <div>
                            <strong>Rafales de Vent</strong>
                            <div id="windGusts" class="text-xl font-bold"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="text-xl font-semibold text-center mb-4">Prévisions de Vent pour 10 Jours</h3>
                <canvas id="windGustsChart" class="w-full h-64"></canvas>
                <canvas id="windDirectionChart" class="w-full h-64 mt-4"></canvas>
            </div>
        </div>

        <div id="errorMessage" class="text-red-500 text-center mt-4 hidden"></div>
    </div>

    <script>
        const sites = [
       {
            "id": "370",
            "nom": "CHASPINHAC (NE)",
            "code": "370",
            "commune": "CHASPINHAC",
            "code_postal": "43700",
            "activite": "parapente  [ déco ]",
            "statut": "actif",
            "latitude": 45.1033,
            "longitude": 3.93,
            "altitude": 931,
            "secteurs_vent": "NE;ESecteurs de vent défavorables : Non renseignéConditions aérologiques idéales : bon site de restitution",
            "orientation": "NE"
		},
		{
            "id": "374",
            "nom": "CHAUDEYROLLES (N)",
            "code": "374",
            "commune": "CHAUDEYROLLES",
            "code_postal": "43430",
            "activite": "parapente delta  [ déco ]",
            "statut": "actif",
            "latitude": 44.936,
            "longitude": 4.1916,
            "altitude": 1383,
            "secteurs_vent": "NSecteurs de vent défavorables : E;SE;S;SO;O;NOConditions aérologiques idéales : Régime de Nord",
            "orientation": "N"
		},
		{
            "id": "5153",
            "nom": "MONT-GERBIZON (E)",
            "code": "5153",
            "commune": "CHAMALIERES-SUR-LOIRE",
            "code_postal": "43800",
            "activite": "parapente  [ déco ]",
            "statut": "actif",
            "latitude": 45.1911,
            "longitude": 3.9913,
            "altitude": 978,
            "secteurs_vent": "Non renseignéSecteurs de vent défavorables : Non renseignéConditions aérologiques idéales : Non renseigné",
            "orientation": "N0"
		},
		{
            "id": "372",
            "nom": "LA DENISE (O)",
            "code": "372",
            "commune": "POLIGNAC",
            "code_postal": "43000",
            "activite": "parapente  [ déco ]",
            "statut": "actif",
            "latitude": 45.0581,
            "longitude": 3.854,
            "altitude": 883,
            "secteurs_vent": "SO;OSecteurs de vent défavorables : S;NOConditions aérologiques idéales : Non renseigné",
            "orientation": "O"
		},
		{
            "id": "13590",
            "nom": "MONT-GERBIZON (E)",
            "code": "13590",
            "commune": "RETOURNAC",
            "code_postal": "43130",
            "activite": "parapente  [ déco ]",
            "statut": "actif",
            "latitude": 45.1887,
            "longitude": 4.0007,
            "altitude": 1064,
            "secteurs_vent": "NE;ESecteurs de vent défavorables : N;SE;S;SO;O;NOConditions aérologiques idéales : Vent de Nord/Est à Est et conditions thermiques",
            "orientation": "NE"
		},
		{
            "id": "3030",
            "nom": "SAINTE ANNE (SO)",
            "code": "3030",
            "commune": "POLIGNAC",
            "code_postal": "43770",
            "activite": "parapente  [ déco ]",
            "statut": "actif",
            "latitude": 45.0707,
            "longitude": 3.8433,
            "altitude": 792,
            "secteurs_vent": "Non renseignéSecteurs de vent défavorables : Non renseignéConditions aérologiques idéales : Non renseigné",
            "orientation": "SO"
		},
        {
        "id": "5154",
        "nom": "CONILS (O)",
        "code": "5154",
        "commune": "SAINT-DIDIER-D'ALLIER",
        "code_postal": "43580",
        "activite": "parapente  [ déco ]",
        "statut": "actif",
        "latitude": 44.9648,
        "longitude": 3.7056,
        "altitude": 1090,
        "secteurs_vent": "Non renseignéSecteurs de vent défavorables : Non renseignéConditions aérologiques idéales : Non renseigné",
        "orientation":"O"
        },
        {
        "id": "376",
        "nom": "MONT ALAMBRE (S)",
        "code": "376",
        "commune": "LES ESTABLES",
        "code_postal": "43150",
        "activite": "parapente  [ déco ]",
        "statut": "actif",
        "latitude": 44.9139,
        "longitude": 4.1542,
        "altitude": 1583,
        "secteurs_vent": "SSecteurs de vent défavorables : N;NE;E;O;NOConditions aérologiques idéales : Vent ou brise de Sud. S'il y a une petite tendance Sud Ouest, préférez monter au sommet et choisissez la pente herbeuse mieux orienté.",
        "orientation": "S"
        },
    ];

        async function loadCities() {
            // Remplir le menu déroulant
            const cityDropdown = document.getElementById('cityDropdown');
            sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.commune;
                option.textContent = site.nom;
                cityDropdown.appendChild(option);
            });
        }
        // Charger les villes au chargement de la page
        document.addEventListener('DOMContentLoaded', loadCities);
 
        let windDirectionChart = null;
        let windGustsChart = null;

        const WIND_DIRECTIONS = {
                180: 'S',
                202.5: 'SSO',
                225: 'SO',
                247.5: 'OSO',
                270: 'O',
                292.5: 'ONO',
                315: 'NO',
                337.5: 'NNO',
                0: 'N',
                22.5: 'NNE',
                45: 'NE',
                67.5: 'ENE',
                90: 'E',
                112.5: 'ESE',
                135: 'SE',
                157.5: 'SSE'
        };

        function getWindDirectionText(degrees) {
            // Find the closest direction
            const closestDegree = Object.keys(WIND_DIRECTIONS)
                .map(Number)
                .reduce((prev, curr) => 
                    (Math.abs(curr - degrees) < Math.abs(prev - degrees) ? curr : prev)
                );
            return WIND_DIRECTIONS[closestDegree];
        }

        function createWindDirectionChart(dates, windDirections) {
            const ctx = document.getElementById('windDirectionChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (windDirectionChart) {
                windDirectionChart.destroy();
            }

            // Convert degrees to direction text
            const windDirectionTexts = windDirections.map(getWindDirectionText);

            windDirectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Direction du Vent',
                        data: windDirections,
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Direction du Vent'
                            },
                            ticks: {
                                callback: function(value) {
                                    return getWindDirectionText(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return getWindDirectionText(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createWindGustsChart(dates, windSpeeds, windGusts) {
            const ctx = document.getElementById('windGustsChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (windGustsChart) {
                windGustsChart.destroy();
            }

            windGustsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Vitesse du Vent (km/h)',
                            data: windSpeeds,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.2
                        },
                        {
                            label: 'Rafales de Vent (km/h)',
                            data: windGusts,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Vitesse du Vent et Rafales'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Vitesse (km/h)'
                            }
                        }
                    },
                    plugins: [{
                        id: 'afterDraw',
                        afterDraw: (chart) => {
                            const { ctx, chartArea } = chart;
                            // Zone pour vitesse du vent < 20 km/h
                            ctx.save();
                            ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                            ctx.fillRect(
                                chartArea.left, 
                                chartArea.bottom - (20 * chart.scales.y.height / chart.scales.y.max), 
                                chartArea.width, 
                                (20 * chart.scales.y.height / chart.scales.y.max)
                            );
                            // Zone pour rafales de vent < 30 km/h
                            ctx.fillStyle = 'rgba(255, 255, 0, 0.1)';
                            ctx.fillRect(
                                chartArea.left, 
                                chartArea.bottom - (30 * chart.scales.y.height / chart.scales.y.max), 
                                chartArea.width, 
                                (10 * chart.scales.y.height / chart.scales.y.max)
                            );
                            ctx.restore();
                        }
                    }]
                }
            });
        }

        function listLowWindPeriods(dates, windSpeeds, windDirections, windGusts, siteOrientation) {
            // Supprimer l'ancienne fenêtre si elle existe
            const existingResultsContainer = document.getElementById('lowWindPeriods');
            if (existingResultsContainer) {
                existingResultsContainer.remove();
            }

            // Créer un nouveau conteneur pour les résultats
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'lowWindPeriods'; // Ajoutez un ID unique pour identifier ce conteneur
            resultsContainer.classList.add('mt-6', 'p-4', 'bg-blue-50', 'rounded-lg', 'shadow-md');
    
            const title = document.createElement('h4');
            title.textContent = `Périodes favorables: vent < 15 km/h, rafales < 25 km/h, direction proche de ${siteOrientation}`;
            title.classList.add('text-lg', 'font-semibold', 'mb-4');
            resultsContainer.appendChild(title);

            const list = document.createElement('ul');
            list.classList.add('list-disc', 'pl-6');

            let perfectOrientation = 0;
            const favorableDays = {}; // Stocker les périodes favorables par jour

            // Convertir l'orientation du site en degrés
            const orientationDegrees = Object.keys(WIND_DIRECTIONS).find(
                key => WIND_DIRECTIONS[key] === siteOrientation
            );

            if (!orientationDegrees) {
                console.error(`Orientation inconnue : ${siteOrientation}`);
                return;
            }

            const orientationRange = {
                min: (orientationDegrees - 45 + 360) % 360, // 45° avant
                max: (parseFloat(orientationDegrees) + 45) % 360 // 45° après
            };

            for (let i = 0; i < dates.length; i++) {
                const speed = windSpeeds[i];
                const direction = windDirections[i];
                const gust = windGusts[i];
                const directionText = getWindDirectionText(direction);

                // Vérifier si la direction est dans la plage acceptable
                const isDirectionValid = 
                    (orientationRange.min <= orientationRange.max && direction >= orientationRange.min && direction <= orientationRange.max) ||
                    (orientationRange.min > orientationRange.max && (direction >= orientationRange.min || direction <= orientationRange.max));


                // Extract the hour from the date
                const rawDate = dates[i];
                const hour = rawDate.split(' ')[2].replace('h', '').trim();

                // Check if wind speed is < 20, gusts < 30 and direction is between NNO and E
                if (speed < 15 && gust < 25 && isDirectionValid && hour >= 10 && hour <= 19) {
                    console.log(`Valid: ${hour} - ${speed} km/h - Rafales: ${gust} km/h - ${directionText}`);
                    const listItem = document.createElement('li');
                    listItem.textContent = `${dates[i]} - ${speed.toFixed(1)} km/h - Rafales: ${gust.toFixed(1)} km/h - ${directionText}`;
                    list.appendChild(listItem);
                    
                    // Extraire le jour de la date
                    const day = dates[i].split(' ')[0] + ' ' + dates[i].split(' ')[1];
                    if (!favorableDays[day]) {
                        favorableDays[day] = 0;
                    }
                    favorableDays[day]++;

                    // Count occurrences of 'N'
                    if (directionText === siteOrientation) {
                        perfectOrientation++;
                    }
                }
            }

            resultsContainer.appendChild(list);

            // Add the count of 'N' occurrences
            const perfectOrientationText = document.createElement('p');
            perfectOrientationText.textContent = `Top : Le vent vient de ${siteOrientation} : ${perfectOrientation} fois.`;
            perfectOrientationText.classList.add('mt-4', 'font-bold');
            resultsContainer.appendChild(perfectOrientationText);

            // Append the results to the weather info section
            document.getElementById('weatherInfo').appendChild(resultsContainer);
            
            const additionalInfo = document.getElementById('additionalInfo');
            // Insérer les résultats juste après le conteneur "additionalInfo"
            // additionalInfo.parentNode.insertBefore(resultsContainer, additionalInfo.nextSibling);
            
            // Identifier les meilleurs jours
            const bestDays = Object.keys(favorableDays).filter(day => favorableDays[day] >= 4);

            // Ajouter les meilleurs jours dans "additionalInfo"
            if (bestDays.length > 0) {
                const bestDaysText = document.createElement('p');
                bestDaysText.classList.add('mt-4', 'text-green-600', 'font-semibold');
                bestDaysText.textContent = `Les meilleurs jours sont : ${bestDays.join(', ')} ⭐`;
                additionalInfo.appendChild(bestDaysText);
            }

        }

        async function fetchWeather() {
            const cityDropdown = document.getElementById('cityDropdown').value;
            const city = cityDropdown; 
            const weatherInfo = document.getElementById('weatherInfo');
            const errorMessage = document.getElementById('errorMessage');
            
            // Reset previous state
            weatherInfo.classList.add('hidden');
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';

            if (!city) {
                errorMessage.textContent = 'Veuillez entrer un nom de ville';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                // Charger les données du fichier JSON
                const site = sites.find(site => site.commune === city);

                if (!site) {
                    throw new Error('Données du site introuvables');
                }
                
                // First, get coordinates
                // const location = await getCoordinates(city);

                // Then fetch weather data with wind gusts
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${site.latitude}&longitude=${site.longitude}&hourly=windspeed_10m,winddirection_10m,windgusts_10m&current_weather=true&windspeed_unit=kmh&timezone=auto&forecast_days=10`
                );
                const weatherData = await weatherResponse.json();

                // Update current weather UI
                document.getElementById('cityName').textContent = site.commune;
                // Ajouter les informations supplémentaires
                const additionalInfo = document.getElementById('additionalInfo');
                additionalInfo.innerHTML = `
                    <div class="bg-gray-100 p-4 rounded-lg text-left text-sm">
                        ${site.description ? `<p><strong>Description :</strong> ${site.description}</p>` : ''}
                        ${site.orientation ? `<p><strong>Orientation :</strong> ${site.orientation}</p>` : ''}
                        ${site.observations ? `<p><strong>Observations :</strong> ${site.observations}</p>` : ''}
                    </div>
                `;
                document.getElementById('temperature').textContent = `${Math.round(weatherData.current_weather.temperature)}°C`;
                
                const currentWindSpeed = weatherData.current_weather.windspeed;
                const currentWindDirection = weatherData.current_weather.winddirection;
                
                document.getElementById('windSpeed').textContent = `${currentWindSpeed.toFixed(1)} km/h`;
                document.getElementById('windDirection').textContent = getWindDirectionText(currentWindDirection);
                
                // Get current hour index and show current wind gust
                const currentTime = new Date();
                const currentHourIndex = weatherData.hourly.time.findIndex(time => 
                    new Date(time).getHours() === currentTime.getHours() && 
                    new Date(time).getDate() === currentTime.getDate()
                );
                
                const currentWindGust = currentHourIndex !== -1 ? 
                    weatherData.hourly.windgusts_10m[currentHourIndex] : 
                    "N/A";
                
                document.getElementById('windGusts').textContent = `${typeof currentWindGust === 'number' ? currentWindGust.toFixed(1) : currentWindGust} km/h`;

                // Prepare data for charts
                const hourlyDates = weatherData.hourly.time.slice(0, 240); // 10 days * 24 hours
                const hourlyWindSpeeds = weatherData.hourly.windspeed_10m.slice(0, 240);
                const hourlyWindDirections = weatherData.hourly.winddirection_10m.slice(0, 240);
                const hourlyWindGusts = weatherData.hourly.windgusts_10m.slice(0, 240);

                // Format dates
                const formattedDates = hourlyDates.map(date => new Date(date).toLocaleString('fr-FR', { 
                    weekday: 'short',
                    day: 'numeric', 
                    hour: '2-digit' 
                }));

                // Create charts - removed the first chart and kept only gusts chart and direction chart
                createWindGustsChart(formattedDates, hourlyWindSpeeds, hourlyWindGusts);
                createWindDirectionChart(formattedDates, hourlyWindDirections);
                listLowWindPeriods(formattedDates, hourlyWindSpeeds, hourlyWindDirections, hourlyWindGusts, site.orientation);
                
                // Show weather info
                weatherInfo.classList.remove('hidden');

            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.remove('hidden');
            }
        }

        async function getCoordinates(city) {
            try {
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=fr&format=json`);
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error('Ville non trouvée');
                }
                
                return {
                    latitude: data.results[0].latitude,
                    longitude: data.results[0].longitude,
                    name: data.results[0].name
                };
            } catch (error) {
                throw new Error('Impossible de trouver les coordonnées de la ville');
            }
        }
    </script>
</body>
</html>