<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Météo Détaillée</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gradient-to-r from-blue-100 to-blue-300 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">Météo Détaillée</h1>
            <div class="flex mt-4">
                <input type="text" id="cityInput" placeholder="Entrez une ville" 
                    class="flex-grow p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="fetchWeather()" 
                    class="bg-blue-500 text-white p-2 rounded-r-lg hover:bg-blue-600 transition">
                    Rechercher
                </button>
            </div>
        </div>

        <div id="weatherInfo" class="hidden">
            <div class="text-center">
                <h2 id="cityName" class="text-2xl font-semibold"></h2>
                <div id="temperature" class="text-5xl font-bold text-blue-700 my-4"></div>
                
                <div class="grid grid-cols-3 gap-4 mt-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <i class="fas fa-wind text-blue-500 text-2xl mb-2"></i>
                        <div>
                            <strong>Vitesse du Vent</strong>
                            <div id="windSpeed" class="text-xl font-bold"></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <i class="fas fa-compass text-blue-500 text-2xl mb-2"></i>
                        <div>
                            <strong>Direction du Vent</strong>
                            <div id="windDirection" class="text-xl font-bold"></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <i class="fas fa-bolt text-yellow-500 text-2xl mb-2"></i>
                        <div>
                            <strong>Rafales de Vent</strong>
                            <div id="windGusts" class="text-xl font-bold"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="text-xl font-semibold text-center mb-4">Prévisions de Vent pour 10 Jours</h3>
                <canvas id="windGustsChart" class="w-full h-64"></canvas>
                <canvas id="windDirectionChart" class="w-full h-64 mt-4"></canvas>
            </div>
        </div>

        <div id="errorMessage" class="text-red-500 text-center mt-4 hidden"></div>
    </div>

    <script>
        let windDirectionChart = null;
        let windGustsChart = null;

        const WIND_DIRECTIONS = {
                180: 'S',
                202.5: 'SSO',
                225: 'SO',
                247.5: 'OSO',
                270: 'O',
                292.5: 'ONO',
                315: 'NO',
                337.5: 'NNO',
                0: 'N',
                22.5: 'NNE',
                45: 'NE',
                67.5: 'ENE',
                90: 'E',
                112.5: 'ESE',
                135: 'SE',
                157.5: 'SSE'
        };

        const DATA = {
            'S': 1,
            'SSO': 2,
            'SO': 3,
            'OSO': 4,
            'O': 5,
            'ONO': 6,
            'NO': 7,
            'NNO': 8,
            'N': 9,
            'NNE': 10,
            'NE': 11,
            'ENE': 12,
            'E': 13,
            'ESE': 14,
            'SE': 15,
            'SSE': 16
        };

        function getWindDirectionText(degrees) {
            // Find the closest direction
            const closestDegree = Object.keys(WIND_DIRECTIONS)
                .map(Number)
                .reduce((prev, curr) => 
                    (Math.abs(curr - degrees) < Math.abs(prev - degrees) ? curr : prev)
                );
            return WIND_DIRECTIONS[closestDegree];
        }

        function createWindDirectionChart(dates, windDirections) {
            const ctx = document.getElementById('windDirectionChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (windDirectionChart) {
                windDirectionChart.destroy();
            }

            // Map wind directions to their corresponding values in DATA
            const mappedWindDirections = windDirections.map(direction => DATA[getWindDirectionText(direction)]);

            // Get the custom order for the Y-axis based on DATA keys
            const customOrder = Object.keys(DATA);

            windDirectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Direction du Vent',
                        data: mappedWindDirections,
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Direction du Vent'
                            },
                            ticks: {
                                callback: function(value) {
                                    // Reverse map the value to the corresponding wind direction
                                    return customOrder[value - 1]; // Adjust index to match array position
                                }
                            },
                            min: 1, // Start from the first index
                            max: customOrder.length // End at the last index
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Display the wind direction text in the tooltip
                                    return customOrder[context.parsed.y - 1];
                                }
                            }
                        }
                    }
                }
            });
        }

        function createWindGustsChart(dates, windSpeeds, windGusts) {
            const ctx = document.getElementById('windGustsChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (windGustsChart) {
                windGustsChart.destroy();
            }

            windGustsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Vitesse du Vent (km/h)',
                            data: windSpeeds,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.2
                        },
                        {
                            label: 'Rafales de Vent (km/h)',
                            data: windGusts,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Vitesse du Vent et Rafales'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Vitesse (km/h)'
                            }
                        }
                    },
                    plugins: [{
                        id: 'afterDraw',
                        afterDraw: (chart) => {
                            const { ctx, chartArea } = chart;
                            // Zone pour vitesse du vent < 20 km/h
                            ctx.save();
                            ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                            ctx.fillRect(
                                chartArea.left, 
                                chartArea.bottom - (20 * chart.scales.y.height / chart.scales.y.max), 
                                chartArea.width, 
                                (20 * chart.scales.y.height / chart.scales.y.max)
                            );
                            // Zone pour rafales de vent < 30 km/h
                            ctx.fillStyle = 'rgba(255, 255, 0, 0.1)';
                            ctx.fillRect(
                                chartArea.left, 
                                chartArea.bottom - (30 * chart.scales.y.height / chart.scales.y.max), 
                                chartArea.width, 
                                (10 * chart.scales.y.height / chart.scales.y.max)
                            );
                            ctx.restore();
                        }
                    }]
                }
            });
        }

        function listLowWindPeriods(dates, windSpeeds, windDirections, windGusts) {
            const resultsContainer = document.createElement('div');
            resultsContainer.classList.add('mt-6', 'p-4', 'bg-blue-50', 'rounded-lg', 'shadow-md');
            
            const title = document.createElement('h4');
            title.textContent = 'Périodes favorables: vent < 20 km/h, rafales < 30 km/h, direction entre NNO et E';
            title.classList.add('text-lg', 'font-semibold', 'mb-4');
            resultsContainer.appendChild(title);

            const list = document.createElement('ul');
            list.classList.add('list-disc', 'pl-6');

            let northCount = 0;

            for (let i = 0; i < dates.length; i++) {
                const speed = windSpeeds[i];
                const direction = windDirections[i];
                const gust = windGusts[i];
                const directionText = getWindDirectionText(direction);

                // Extract the hour from the date
                const rawDate = dates[i];
                const hour = rawDate.split(' ')[2].replace('h', '').trim();

                // Check if wind speed is < 20, gusts < 30 and direction is between NNO and E
                if (speed < 20 && gust < 30 && (direction >= 337.5 || direction <= 90) && hour >= 10 && hour <= 19) {
                    console.log(`Valid: ${hour} - ${speed} km/h - Rafales: ${gust} km/h - ${directionText}`);
                    const listItem = document.createElement('li');
                    listItem.textContent = `${dates[i]} - ${speed.toFixed(1)} km/h - Rafales: ${gust.toFixed(1)} km/h - ${directionText}`;
                    list.appendChild(listItem);

                    // Count occurrences of 'N'
                    if (directionText === 'N') {
                        northCount++;
                    }
                }
            }

            resultsContainer.appendChild(list);

            // Add the count of 'N' occurrences
            const northCountText = document.createElement('p');
            northCountText.textContent = `Top : Le vent vient de 'N' ${northCount} fois.`;
            northCountText.classList.add('mt-4', 'font-bold');
            resultsContainer.appendChild(northCountText);

            // Append the results to the weather info section
            document.getElementById('weatherInfo').appendChild(resultsContainer);
        }

        async function fetchWeather() {
            const city = document.getElementById('cityInput').value;
            const weatherInfo = document.getElementById('weatherInfo');
            const errorMessage = document.getElementById('errorMessage');
            
            // Reset previous state
            weatherInfo.classList.add('hidden');
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';

            if (!city) {
                errorMessage.textContent = 'Veuillez entrer un nom de ville';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                // First, get coordinates
                const location = await getCoordinates(city);

                // Then fetch weather data with wind gusts
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&hourly=windspeed_10m,winddirection_10m,windgusts_10m&current_weather=true&windspeed_unit=kmh&timezone=auto&forecast_days=10`
                );
                const weatherData = await weatherResponse.json();

                // Update current weather UI
                document.getElementById('cityName').textContent = location.name;
                document.getElementById('temperature').textContent = `${Math.round(weatherData.current_weather.temperature)}°C`;
                
                const currentWindSpeed = weatherData.current_weather.windspeed;
                const currentWindDirection = weatherData.current_weather.winddirection;
                
                document.getElementById('windSpeed').textContent = `${currentWindSpeed.toFixed(1)} km/h`;
                document.getElementById('windDirection').textContent = getWindDirectionText(currentWindDirection);
                
                // Get current hour index and show current wind gust
                const currentTime = new Date();
                const currentHourIndex = weatherData.hourly.time.findIndex(time => 
                    new Date(time).getHours() === currentTime.getHours() && 
                    new Date(time).getDate() === currentTime.getDate()
                );
                
                const currentWindGust = currentHourIndex !== -1 ? 
                    weatherData.hourly.windgusts_10m[currentHourIndex] : 
                    "N/A";
                
                document.getElementById('windGusts').textContent = `${typeof currentWindGust === 'number' ? currentWindGust.toFixed(1) : currentWindGust} km/h`;

                // Prepare data for charts
                const hourlyDates = weatherData.hourly.time.slice(0, 240); // 10 days * 24 hours
                const hourlyWindSpeeds = weatherData.hourly.windspeed_10m.slice(0, 240);
                const hourlyWindDirections = weatherData.hourly.winddirection_10m.slice(0, 240);
                const hourlyWindGusts = weatherData.hourly.windgusts_10m.slice(0, 240);

                // Format dates
                const formattedDates = hourlyDates.map(date => new Date(date).toLocaleString('fr-FR', { 
                    weekday: 'short',
                    day: 'numeric', 
                    hour: '2-digit' 
                }));

                // Create charts - removed the first chart and kept only gusts chart and direction chart
                createWindGustsChart(formattedDates, hourlyWindSpeeds, hourlyWindGusts);
                createWindDirectionChart(formattedDates, hourlyWindDirections);
                listLowWindPeriods(formattedDates, hourlyWindSpeeds, hourlyWindDirections, hourlyWindGusts);
                
                // Show weather info
                weatherInfo.classList.remove('hidden');

            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.remove('hidden');
            }
        }

        async function getCoordinates(city) {
            try {
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=fr&format=json`);
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error('Ville non trouvée');
                }
                
                return {
                    latitude: data.results[0].latitude,
                    longitude: data.results[0].longitude,
                    name: data.results[0].name
                };
            } catch (error) {
                throw new Error('Impossible de trouver les coordonnées de la ville');
            }
        }
    </script>
</body>
</html>